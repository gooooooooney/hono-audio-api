# 意图检测+汇报模型

## 状态定义

### 1. `LISTENING_IDLE`
表示正在监听**流式ASR模型**结果并等待'frapp'关键词触发。

### 2. `FRAPP_INTENTION`
识别到'frapp'关键词，等待后续的指令内容。

### 3. `FRAPP_INTENTION_PROLONG`
识别到'frapp'关键词，且触发了**静音检测**，但是经过**语义识别模型**后，认为说话内容并没有结束，继续等待1.5s。

### 4. `FRAPP_INTENTION_DETECTING`
识别到'frapp'或从'FRAPP_INTENTION_WAITFOR_EXECUTION'跳转，且认为句已经结束时，调用**意图识别模型**进行检测。

- **子状态1**: `FRAPP_INTENTION_FAILED` - 无法检测意图或意图无效
- **子状态2**: `FRAPP_INTENTION_DETECTED` - 意图有效

### 5. `FRAPP_INTENTION_WAITFOR_EXECUTION`
意图检测成功。此时不进行直接的intention调用，而是等待用户2.5s，用户也许有意图补充：

> "帮我查一下xx. (1s后)再帮我查一下xx和xx. (2.3s后)稍等, 还有xx也帮我再调研一下."

这个阶段的执行逻辑类似`FRAPP_INTENTION_PROLONG`，需要调用**意图识别模型**。

同时，需要把此'frapp'之前的文本，使用**语义总结模型**进行一次总结。

### 6. `FRAPP_EXECUTING`
调用**意图执行模型**。在执行完毕后，会调用**语义总结模型**，给出最后精简的回答。并把经过**TTS模型**后的回答，加入到回复列表中。

随后，重新回到`LISTENING_IDLE`状态。

## 涉及的模型

### 1. 流式ASR模型+静音检测和TTS模型
用于将语音转换为文本和文本转语音。
- **默认使用**: 火山流式ASR模型和minimax的TTS模型
- **特点**: 
  - 火山流式ASR模型只获取最终的识别结果，以及通过时间戳做静音检测
  - minimax的TTS模型会有首句TTS的设计

### 2. 语义识别模型
语义识别模型通过给出ASR识别出的句子，判断这句话有没有把话说完，或者用户有没有在犹豫并打算继续说话。
- **工作原理**: 需要ASR模型中的VAD结果，判断有没有发出声音，通过声音和内容同时去做判断
- **默认模型**: Gemini 2.0 Flash

### 3. 意图识别模型  
给定几句文本，使用模型识别文本中的意图。
- **处理逻辑**: 
  - 可能判断出里面没有任何有意义的意图或者有害的意图，此时返回`FRAPP_INTENTION_FAILED`
  - 否则返回`FRAPP_INTENTION_DETECTED`以及对应的意图
- **默认模型**: Gemini 2.0 Flash

### 4. 意图执行模型
如果有意图，则把他展开成可以问模型的形式，并在prompt中添加RAG后的上下文。
- **上下文处理**: 现在可能只是把所有上文都拿过来
- **默认模型**: Gemini 2.5 Pro

### 5. 语义总结模型
用于对文本进行总结，尽可能变得口语化且简洁，方便用户听起来直观。
- **默认模型**: Gemini 2.0 Flash

## 状态跳转逻辑和实现细节

### 状态1 → 状态2
**关键词匹配逻辑**
- 对新流入的ASR文本，设定一个窗口：20个中文汉字（12个单词）
- 如果检测到关键词，则立刻跳转到状态2

### 状态2 → 状态3 → 状态4
**静音检测和语义判断**
1. **静音检测**: 检测到超过600ms的静音，认为这是一次有意义的停顿
2. **ASR结合**: 获得静音前到'frapp'唤醒词之间所有的ASR结果
3. **语义判断**: 将结果发送给语义识别模型判断话有没有说完
   - 说完了 → 直接跳转到状态4
   - 未说完 → 等待1.5s

**等待期间的处理**:
- 1.5s内遇到静音 → 重复语义识别模型的检测
- 1.5s内未遇到静音 → 继续识别

**全局限制**:
- 文本长度: 120个字（可能要换算成单词）
- 音频长度: 30s
- 任何一个触发，都强行跳转到状态4

### 状态4 → 状态5
当意图识别调用完毕后，自动跳转到状态5。

### 状态5 → 状态2/状态6
**等待期间的意图补充处理**:
- 类似状态2，超过600ms的静音后，得到静音前到'frapp'唤醒词之间所有的ASR结果
- 判断新加入的内容，有没有更改或增加意图
  - **有更改或增加意图** → 重新回到状态2
  - **否则** → 跳转到状态6
     